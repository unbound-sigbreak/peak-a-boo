import{interpolate as l}from"./interpolate.js";function a(s){return new Promise((o,t)=>{chrome.tabs.query({},e=>{let r=e.find(e=>e.url?.endsWith(s));return(r=r||e.find(e=>e.pendingUrl?.endsWith(s)))?o(r):t(new Error(`No tab with URL "${s}" found.`))})})}chrome.runtime.onInstalled.addListener(()=>{console.log("Reddit Peak-A-Boo installed")});const d=(e,r,o)=>{if(!e?.data?.children)return{o:[],t:0};var t=e.data.children,s=[];let a=0;for(let e=0;e<t.length&&!(o&&e>=o&&0<o);e++){var n,m,c=t[e],l={};for([n,m]of Object.entries(r))l[n]=((e,r)=>{var o;let t=e;for(o of r.split(".")){var s,a=o.match(/(\w+)\[(\d+)\]/);if(void 0===(t=a?(s=a[1],a=parseInt(a[2],10),t[s]?t[s][a]:void 0):t[o]))break}return t})(c,m);s.push(l),a++}return{o:s,t:a}};chrome.runtime.onMessage.addListener((r,e,n)=>{if("sendRawCommentContentToModal"===r.action&&a("modal.html?username="+r.content.username).then(e=>{chrome.tabs.sendMessage(e.id,{type:"SET_RAW_COMMENTS",content:r.content})}).catch(e=>{console.log("tab not found",e)}),"sendParsedCommentContentToModal"===r.action&&a("modal.html?username="+r.content.username).then(e=>{chrome.tabs.sendMessage(e.id,{type:"SET_PARSED_COMMENTS",content:r.content})}).catch(e=>{console.log("tab not found",e)}),"parseCommentsForLlm"===r.action){const t=r["rawComments"];return chrome.storage.local.get(["commentMapper","maxComments"],e=>{e=d(t,JSON.parse(e.commentMapper),e.maxComments);n(e)}),!0}if("getSettings"===r.action)return chrome.storage.local.get(["apiUrl","llmPrompt","payloadObject","requestHeaders"],e=>{n(e)}),!0;if("performLlmApiCall"===r.action){const{username:m,m:c}=r?.content??{};return chrome.storage.local.get(["apiUrl","llmPrompt","payloadObject","requestHeaders","apiKey"],o=>{var{l:r,i:t,p:s,u:a}=o;if(r){t=l(t,{h:JSON.stringify(c,null,0).replace(/\\/g,"\\\\").replace(/"/g,'\\"'),username:m}),s=l(s,{i:t});let e;try{e=JSON.parse(s)}catch(e){return console.log("Error parsing JSON payload:",e),void n({error:"Error parsing JSON payload"})}t=a.reduce((e,r)=>(e[r.key]=l(r.value,{O:o.O}),e),{});fetch(r,{method:"POST",headers:t,body:JSON.stringify(e)}).then(e=>e.json()).then(e=>{n({P:!0,data:e})}).catch(e=>{console.log("Error:",e),n({P:!1,error:e.message})})}else console.log("API URL is missing"),n({P:!1,error:"API URL is missing"})}),!0}if("fetchRedditUserData"===r.action){var o=r["username"];const s=`https://www.reddit.com/user/${o}.json`;return chrome.cookies.getAll({domain:".reddit.com"},e=>{e=e.map(e=>e.name+"="+e.value).join("; ");fetch(s,{method:"GET",headers:{S:e}}).then(e=>e.json()).then(e=>{n({P:!0,data:e})}).catch(e=>{console.log("Error fetching Reddit user data:",e),n({error:e.message})})}),!0}});