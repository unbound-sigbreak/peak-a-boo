const p=[{key:"Authorization",value:"Bearer {$apiKey}"},{key:"Content-Type",value:"application/json"}],h=[{key:"Content-Type",value:"application/json"}];document.addEventListener("DOMContentLoaded",()=>{const e=document.getElementById("main-window");var t=document.getElementById("rescan");const a=document.getElementById("settings-window");var o=document.getElementById("manual-lookup"),n=document.getElementById("settings-button"),s=document.getElementById("reddit-settings-button"),c=document.getElementById("api-settings-button"),r=document.getElementById("other-settings-button"),i=document.getElementById("close-settings");function l(e,t){var s,c,a=document.getElementById(e);for(const o of["reddit-settings","api-settings","other-settings"])o!==e&&document.getElementById(o).classList.add("hidden");a.classList.contains("hidden")&&(s=a,c=t,fetch(c).then(e=>e.text()).then(e=>{if(s.innerHTML=e,"api-settings.html"===c){const a=document.getElementById("save-api-setting"),o=document.getElementById("addHeader"),n=(document.getElementById("requestHeadersContainer"),a.addEventListener("click",()=>{var e,t,a,o,n,s;e=document.getElementById("apiUrl").value,t=document.getElementById("apiKey").value,a=document.getElementById("llmResponseJsonPath").value,o=document.getElementById("llmPrompt").value,n=document.getElementById("payloadObject").value,s=Array.from(document.getElementsByClassName("headerPair")).map(e=>({key:e.querySelector(".headerKey").value,value:e.querySelector(".headerValue").value})),chrome.storage.local.set({t:e,o:t,i:a,l:o,m:n,u:s},()=>{alert("API Settings saved")})}),o.addEventListener("click",()=>{u()}),document.getElementById("apiKey"));n.addEventListener("focus",function(){n.type="text"}),n.addEventListener("blur",function(){n.type="password"}),d()}else"other-settings.html"===c?(e=document.getElementById("clear-storage-openai"),t=document.getElementById("clear-storage-ollama"),e.addEventListener("click",()=>{chrome.storage.local.clear(()=>{m("openai"),d(),alert("Configs reset to OpenAI defaults")})}),t.addEventListener("click",()=>{chrome.storage.local.clear(()=>{m("ollama"),d(),alert("Configs reset to Ollama defaults")})})):"reddit-settings.html"===c&&(document.getElementById("save-reddit-setting").addEventListener("click",()=>{var e=document.getElementById("commentMapper")?.value??null,t=document.getElementById("maxComments")?.value??null;try{JSON.parse(e)}catch(e){return void alert("Invalid JSON for comment mapper. No settings saved.")}chrome.storage.local.set({p:e,h:t},()=>{alert("Reddit Settings saved")})}),d());var t}),a.classList.remove("hidden"))}function d(){chrome.storage.local.get(["apiUrl","apiKey","llmResponsePath","llmPrompt","payloadObject","requestHeaders","commentMapper","maxComments"],e=>{var t=document.getElementById("commentMapper"),a=document.getElementById("maxComments"),o=document.getElementById("apiUrl"),n=document.getElementById("apiKey"),s=document.getElementById("llmResponseJsonPath"),c=document.getElementById("llmPrompt"),r=document.getElementById("payloadObject"),i=document.getElementById("requestHeadersContainer");t&&(t.value=e.p),a&&(a.value=e.h||""),o&&(o.value=e.t),n&&(n.value=e.o||""),s&&(s.value=e.i||""),c&&(c.value=e.l),r&&(r.value=e.m),i&&(t=e.u??[],i.innerHTML="",t.forEach(e=>{u(e.key,e.value)}))})}function m(e){var t,a={p:`{
  "c": "data.body",
  "subr": "data.subreddit",
  "upvotes": "data.ups",
  "threadtitle": "data.link_title",
  "issubmitter": "data.is_submitter"
}`,l:"Please review this user's Reddit comments and provide a summary of their behavior: {$commentJsonData}"};"ollama"===e?(t={...a,t:"http://localhost.:11434/api/generate",i:"response",o:"",m:`{
  "model": "llama3",
  "prompt": "{$llmPrompt}",
  "stream": false
}`,u:h},chrome.storage.local.set(t,()=>{console.log("Default Ollama settings saved")})):"openai"===e&&(t={...a,t:"https://api.openai.com/v1/chat/completions",i:"choices[0].message.content",o:"",m:`{
  "model": "gpt-3.5-turbo-0125",
  "messages": [{"role": "user", "content": "{$llmPrompt}"}],
  "temperature": 0.7
}`,u:p},chrome.storage.local.set(t,()=>{console.log("Default OpenAI settings saved")}))}function u(e="",t=""){const a=document.createElement("div"),o=(a.classList.add("headerPair"),a.innerHTML=`
      <input type="text" class="headerKey" placeholder="Header Key" value="${e}">
      <input type="text" class="headerValue" placeholder="Header Value" value="${t}">
      <button class="removeHeader">X</button>
    `,document.getElementById("requestHeadersContainer"));o.appendChild(a),a.querySelector(".removeHeader").addEventListener("click",()=>{o.removeChild(a)})}o?.addEventListener("click",()=>{alert("Manual Lookup clicked")}),t.addEventListener("click",()=>{chrome.tabs.query({active:!0,g:!0},e=>{chrome.tabs.sendMessage(e[0].id,{action:"llmButtonInjectRescan"})})}),n.addEventListener("click",()=>{e.classList.add("hidden"),a.classList.remove("hidden")}),i.addEventListener("click",()=>{a.classList.add("hidden"),e.classList.remove("hidden")}),s.addEventListener("click",()=>{l("reddit-settings","reddit-settings.html")}),c.addEventListener("click",()=>{l("api-settings","api-settings.html")}),r.addEventListener("click",()=>{l("other-settings","other-settings.html")})});